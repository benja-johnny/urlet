<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<title>Urlet</title>

<script>

// Add/remove (text) from the bookmark title
function modifyBookmarkTitle(ar, txt) {

    // ar = add/remove
    // txt = text to insert/remove
    
    var favlet_title = document.getElementById("favlet").innerHTML;
    
    // If we want to add text
    if((ar == "add") && !favlet_title.includes(txt)) {
    
        const bracket_end = favlet_title.indexOf(")");
        
        // If it's not the only text
        if(bracket_end != -1)
            document.getElementById("favlet").innerHTML =
                favlet_title.slice(0, bracket_end) +
                ", " +
                txt +
                ")";
        else
            document.getElementById("favlet").innerHTML =
                favlet_title +
                " (" +
                txt +
                ")";
    }
    
    // If we want to remove text
    if((ar == "remove") && favlet_title.includes(txt)) {
    
        // If it's the only text
        if(favlet_title.slice(favlet_title.indexOf("(") + 1, favlet_title.lastIndexOf(")")) == txt)
            document.getElementById("favlet").innerHTML = document.title;
            
        else {
        
            // Remove text
            const txt_i = favlet_title.indexOf(txt),
                  ft_length = favlet_title.length;
            
            document.getElementById("favlet").innerHTML =
                favlet_title.slice(0, txt_i) +
                favlet_title.slice(txt_i + txt.length, ft_length);
        
            // Clean up unnecessary commas
            favlet_title = document.getElementById("favlet").innerHTML;
            
            const i_1 = favlet_title.indexOf(", , "),
                  i_2 = favlet_title.indexOf("(,"),
                  i_3 = favlet_title.indexOf(", )");
            
            if(i_1 != -1) document.getElementById("favlet").innerHTML =
                favlet_title.slice(0, i_1) +
                ", " +
                favlet_title.slice(i_1 + 4, ft_length);
            if(i_2 != -1) document.getElementById("favlet").innerHTML =
                favlet_title.slice(0, i_2 + 1) +
                favlet_title.slice(i_2 + 3, ft_length);
            if(i_3 != -1) document.getElementById("favlet").innerHTML =
                favlet_title.slice(0, i_3) +
                ")";
        }
    }
}

// Updates defaults JSON (d) in the bookmarklet script (link)
function updateDefaults() {

    function replaceDefaults(o) {
        
        const bookmark = document.getElementById("favlet"),
              bookmark_href = bookmark.getAttribute("href");
        
        bookmark.setAttribute("href",
            bookmark_href.slice(0, bookmark_href.indexOf("d = {") + 4) +
            JSON.stringify(o) +
            bookmark_href.slice(bookmark_href.lastIndexOf("}; s.id") + 1, bookmark_href.length)
        );
    }
    
    // Only update if the checkbox is checked
    if(document.getElementById("cb_default_settings").checked) {
    
        replaceDefaults({
            "lz_string" : document.getElementById("cb_lz_string").checked,
            "base_64" : document.getElementById("cb_base_64").checked,
            "style" : document.getElementById("cb_style").checked,
            "script" : document.getElementById("cb_script").checked,
            "link" : document.getElementById("cb_link").checked,
            "meta" : document.getElementById("cb_meta").checked,
            "template" : document.getElementById("cb_template").checked,
            "comment" : document.getElementById("cb_comment").checked
        });
        modifyBookmarkTitle("add", "options");
        
    } else {
    
        replaceDefaults({});
        modifyBookmarkTitle("remove", "options");
    }
}

// Updates the keys array (k) in the bookmarklet script (link)
function updateKeys() {

    const bookmark = document.getElementById("favlet");
    const bookmark_href = bookmark.getAttribute("href");
    
    bookmark.setAttribute("href",
        bookmark_href.slice(0, bookmark_href.indexOf("k = [") + 5) +
        "'" +
        document.getElementsByTagName("input")[0].value +
        "', '" +
        document.getElementsByTagName("input")[1].value +
        "'" +
        bookmark_href.slice(bookmark_href.lastIndexOf("], d = {"), bookmark_href.length)
    );
}

// Updates s.src in the bookmarklet script (link)
function updateScriptUrl() {

    const bookmark_url = window.location.href;
    const script_url = bookmark_url.slice(0, bookmark_url.indexOf("/bookmarklet")) + "/scripts/urlet.js";
    const bookmark = document.getElementById("favlet");
    const bookmark_href = bookmark.getAttribute("href");
    
    bookmark.setAttribute("href",
        bookmark_href.slice(0, bookmark_href.indexOf("s.src = '") + 9) +
        script_url +
        bookmark_href.slice(bookmark_href.lastIndexOf("';"), bookmark_href.length)
    );
}

// Select all checkbox selects all checkboxes
function u_select_all(source) {

    const u_checkboxes = document.getElementsByName("urlet_checkbox");
    
    for(var i = 0, n = u_checkboxes.length; i < n; i++) {
        u_checkboxes[i].checked = source.checked;
    }
    
    updateDefaults();
}

// Triggered by defocusing Gist token and Pastebin key input
function checkLength(i) {

    const a = document.getElementsByTagName("input")[i];
    
    // Value can only be 40/32 characters long or empty
    if(((i == 0) && ((a.value.length != 40) && (a.value.length != 0))) || ((i == 1) && ((a.value.length != 32) && (a.value.length != 0)))) {
    
        alert("Please input a valid token.");
        a.value = "";
        updateKeys();
        
    } else
        modifyBookmarkTitle("add", "keys");
    
    // If there's no accepted key, remove (keys)
    if((document.getElementsByTagName("input")[0].value == "") && (document.getElementsByTagName("input")[1].value == ""))
        modifyBookmarkTitle("remove", "keys");
}

// Puts the hostname in the bookmark title
function includeHost() {

    const h_name = window.location.hostname;
    
    if(document.getElementById("cb_include_host").checked)
        modifyBookmarkTitle("add", h_name);
    else
        modifyBookmarkTitle("remove", h_name);
}

// Delete Gist token and Pastebin key
function resetKeys() {
    document.getElementsByTagName("input")[0].value = "";
    document.getElementsByTagName("input")[1].value = "";
}

// These need to be updated after the page has loaded
window.onload = () => {
    document.getElementById("favlet").innerHTML = document.title;
    resetKeys();
    includeHost();
    updateScriptUrl();
    updateKeys();
    updateDefaults();
}

</script>

</head>
<body style="margin:30px">

<h1><a id="favlet" href="javascript:(function(){const s = document.createElement('script'), k = [], d = {}; s.id = 'urlet-item'; s.src = ''; document.getElementsByTagName('head')[0].appendChild(s); s.onload = function() {urlet_menu(s.src, k, d);}})(); void(0);">Urlet</a> â˜œ Save this link to your bookmarks!</h1>
<h2>But before you do...</h2>
<h3>You can hard code the settings below into your bookmark:</h3>

<fieldset style='margin-top:10px;max-width:350px'>
    <legend>Keys</legend>
    <div onkeyup='return updateKeys()'>
    <p>Gist token:<br>
    <input type='text' style='width:90%' placeholder='Must be 40 characters long.' onblur='checkLength(0)'></p>
    <p>Pastebin key:<br>
    <input type='text' style='width:90%' placeholder='Must be 32 characters long.' onblur='checkLength(1)'></p>
    </div>
    <p>To get a Gist token, go here:<br>
    <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a></p>
    <p>To get your Pastebin Developer API Key, go here:<br>
    <a href="https://pastebin.com/api">https://pastebin.com/api</a></p>
</fieldset>

<fieldset style='margin-top:25px;max-width:250px'>
    <legend>Options</legend>
    <table style='width:100%;padding:5px;text-align:left'>
        <tr>
            <th style='padding-bottom:10px'>Include</th>
            <th style='padding-bottom:10px'>Compression</th>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_style' onclick="updateDefaults()"> Style
            </td>
            <td>
                <input type='radio' name='compression' id='cb_lz_string'  checked='checked' onclick="updateDefaults()"> lz-string
            </td>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_script' onclick="updateDefaults()"> Script
            </td>
            <td>
                <input type='radio' name='compression' id='cb_base_64' onclick="updateDefaults()"> base-64
            </td>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_link' onclick="updateDefaults()"> Link
            </td>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_meta' onclick="updateDefaults()"> Meta
            </td>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_template' onclick="updateDefaults()"> Template
            </td>
        </tr>
        <tr>
            <td>
                <input type='checkbox' name='urlet_checkbox' id='cb_comment' onclick="updateDefaults()"> Comment
            </td>
        </tr>
        <tr>
            <td style='padding-top:10px'>
                <input type='checkbox' onClick='u_select_all(this)' /> Select all
            </td>
        </tr>
    </table>
    <p style='margin-top:20px'>
        <input type='checkbox' id='cb_default_settings' onclick='updateDefaults()'> Always use these options
    </p>
</fieldset>

<fieldset style='margin-top:25px;max-width:300px'>
    <legend>Hostname</legend>
    <p>
        <input type='checkbox' id='cb_include_host' onclick='includeHost()'> Include the hostname in the bookmark title
    </p>
</fieldset>

</body>
</html>
